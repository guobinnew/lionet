"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _utils=_interopRequireDefault(require("./utils")),_logger=_interopRequireDefault(require("./logger")),_verison=_interopRequireDefault(require("./verison")),_message=_interopRequireDefault(require("./message")),_atomic=_interopRequireDefault(require("./atomic")),_coupled=_interopRequireDefault(require("./coupled")),_coupledSimulator=_interopRequireDefault(require("./coupled-simulator")),_coupledCoordinator=_interopRequireDefault(require("./coupled-coordinator"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _createForOfIteratorHelper(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,_=!0,u=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return _=t.done,t},e:function(t){u=!0,i=t},f:function(){try{_||null==r.return||r.return()}finally{if(u)throw i}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),t}var DevsCoordinator=function(){function e(t){_classCallCheck(this,e),this.__coupled__=t,this.__coupled__.coordinator(this),this.__couprels__=new Set,this.__simulators__=new Set,this.__tl__=_utils.default.devs.time.Initial,this.__tn__=_utils.default.devs.time.Infinity,this.__input__=null,this.__output__=new _message.default,this.setSimulators(),this.informCoupling()}return _createClass(e,[{key:"tl",value:function(){return this.__tl__}},{key:"tn",value:function(){return this.__tn__}},{key:"initialize",value:function(t){var e,r=0<arguments.length&&void 0!==t?t:_utils.default.devs.time.Initial,n=_createForOfIteratorHelper(this.__simulators__);try{for(n.s();!(e=n.n()).done;){e.value.initialize(r)}}catch(t){n.e(t)}finally{n.f()}this.__tl__=r,this.__tn__=this.nextTN()}},{key:"simulate",value:function(t){for(var e=0;e<t&&!(this.__tl__>=_utils.default.devs.time.Infinity);e++)this.computeInputOutput(this.__tn__),this.wrapDeltafunc(this.__tn__),this.__tl__=this.__tn__,this.__tn__=this.nextTN()}},{key:"simInject",value:function(t,e){t<=this.nextTN()&&(this.__input__=e,this.wrapDeltafunc(t),this.__tl__=t,this.__tn__=this.nextTN())}},{key:"computeInputOutput",value:function(t){this.__output__.clear();var e,r=_createForOfIteratorHelper(this.__simulators__);try{for(r.s();!(e=r.n()).done;){e.value.computeInputOutput(t)}}catch(t){r.e(t)}finally{r.f()}var n,o=_createForOfIteratorHelper(this.__simulators__);try{for(o.s();!(n=o.n()).done;){n.value.sendMessages()}}catch(t){o.e(t)}finally{o.f()}}},{key:"wrapDeltafunc",value:function(t){this.sendDownMessages();var e,r=_createForOfIteratorHelper(this.__simulators__);try{for(r.s();!(e=r.n()).done;){e.value.deltaFunc(t)}}catch(t){r.e(t)}finally{r.f()}this.__input__&&this.__input__.clear()}},{key:"nextTN",value:function(){var t,e=_utils.default.devs.time.Infinity,r=_createForOfIteratorHelper(this.__simulators__);try{for(r.s();!(t=r.n()).done;){var n=t.value.nextTN();n<e&&(e=n)}}catch(t){r.e(t)}finally{r.f()}return e}},{key:"output",value:function(){return this.__output__}},{key:"hasInjectMessage",value:function(){return this.__input__&&!this.__input__.empty()}},{key:"injectMessage",value:function(t){this.__input__||(this.__input__=new _message.default),this.__input__.merge(t)}},{key:"putMessageEvent",value:function(t){t.event.timestamp(this.tn()),this.__output__.addContent(t)}},{key:"coupled",value:function(){return this.__coupled__}},{key:"informCoupling",value:function(){var t,e=_createForOfIteratorHelper(this.__coupled__.couprels().values());try{for(e.s();!(t=e.n()).done;){var r=t.value;r.src===this.__coupled__?this.addCouprel(r):r.src instanceof _atomic.default?r.src.simulator().addCouprel(r):r.src instanceof _coupled.default&&r.src.coordinator().addCouprel(r)}}catch(t){e.e(t)}finally{e.f()}}},{key:"setSimulators",value:function(){var t,e=_createForOfIteratorHelper(this.__coupled__.children().values());try{for(e.s();!(t=e.n()).done;){var r=t.value;r instanceof _atomic.default?this.addSimulator(r):r instanceof _coupled.default&&this.addCoordinator(r)}}catch(t){e.e(t)}finally{e.f()}}},{key:"addSimulator",value:function(t){var e=new _coupledSimulator.default(t);e.parent(this),this.__simulators__.add(e)}},{key:"addCoordinator",value:function(t){var e=new _coupledCoordinator.default(t);e.parent(this),this.__simulators__.add(e)}},{key:"sendDownMessages",value:function(){if(this.__input__&&!this.__input__.empty()){var t,e=_createForOfIteratorHelper(this.convertInput(this.__input__));try{for(e.s();!(t=e.n()).done;){var r=t.value;r.model instanceof _atomic.default?r.model.simulator().putMessageEvent(content):r.model instanceof _coupled.default&&r.model.coordinator().putMessageEvent(content)}}catch(t){e.e(t)}finally{e.f()}}}},{key:"convertInput",value:function(t){var e=new Array;if(t){var r,n=_createForOfIteratorHelper(t.contents());try{for(n.s();!(r=n.n()).done;){var o,i=r.value,_=_createForOfIteratorHelper(this.__couprels__);try{for(_.s();!(o=_.n()).done;){var u=o.value;u.srcPort===i.port&&e.push({model:u.dest,content:{port:u.destPort,event:i.event}})}}catch(t){_.e(t)}finally{_.f()}}}catch(t){n.e(t)}finally{n.f()}}return e}},{key:"addCouprel",value:function(t){t?this.__couprels__.add(t):_logger.default.error("DevsCoordinator::addCouprel failed - rel is null")}},{key:"snapshot",value:function(t){return this.__coupled__?t?void this.__coupled__.snapshot(t.model):{type:"coordinator",version:_verison.default.current,model:this.__coupled__.snapshot()}:(_logger.default.error("DevsCoordinator::snapshot failed - model is null"),null)}},{key:"toJson",value:function(){var t={tl:this.__tl__,tn:this.__tn__};return this.__input__&&(t.input=this.__input__.toJson()),this.__output__&&(t.output=this.__output__.toJson()),t}},{key:"fromJson",value:function(t){if(!t)return _logger.default.error("DevsCoordinator::fromJson failed - json is null"),null;_utils.default.common.isNumber(t.tl)?this.__tl__=t.tl:(_logger.default.warn("DevsCoordinator::fromJson - tl is not a number"),this.__tl__=_utils.default.devs.time.Initial),_utils.default.common.isNumber(t.tn)?this.__tn__=t.tn:(_logger.default.warn("DevsCoordinator::fromJson - tn is not a number"),this.__tn__=_utils.default.devs.time.Infinity),t.input?(this.__input__=new _message.default,this.__input__.fromJson(t.input)):this.__input__=null,t.output&&this.__output__.fromJson(t.output)}}]),e}(),_default=DevsCoordinator;exports.default=DevsCoordinator;