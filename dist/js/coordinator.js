"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _utils=_interopRequireDefault(require("./utils")),_logger=_interopRequireDefault(require("./logger")),_message=_interopRequireDefault(require("./message")),_atomic=_interopRequireDefault(require("./atomic")),_coupled=_interopRequireDefault(require("./coupled")),_coupledSimulator=_interopRequireDefault(require("./coupled-simulator")),_coupledCoordinator=_interopRequireDefault(require("./coupled-coordinator"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),t}var DevsCoordinator=function(){function e(t){_classCallCheck(this,e),this.__coupled__=t,this.__couprels__=new Set,this.__simulators__=new Set,this.__tl__=_utils.default.devs.time.Initial,this.__tn__=_utils.default.devs.time.Infinity,this.__input__=null,this.__output__=new _message.default,this.setSimulators(),this.informCoupling()}return _createClass(e,[{key:"tl",value:function(){return this.__tl__}},{key:"tn",value:function(){return this.__tn__}},{key:"initialize",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:_utils.default.devs.time.Initial,e=!0,r=!1,i=void 0;try{for(var n,u=this.__simulators__[Symbol.iterator]();!(e=(n=u.next()).done);e=!0){n.value.initialize(t)}}catch(t){r=!0,i=t}finally{try{e||null==u.return||u.return()}finally{if(r)throw i}}this.__tl__=t,this.__tn__=this.nextTN()}},{key:"simulate",value:function(t){for(var e=0;e<t&&!(this.__tl__>=_utils.default.devs.time.Infinity);e++)this.computeInputOutput(this.__tn__),this.wrapDeltafunc(this.__tn__),this.__tl__=this.__tn__,this.__tn__=this.nextTN()}},{key:"simInject",value:function(t,e){t<=this.nextTN()&&(this.__input__=e,this.wrapDeltafunc(t),this.__tl__=t,this.__tn__=this.nextTN())}},{key:"computeInputOutput",value:function(t){this.__output__.clear();var e=!0,r=!1,i=void 0;try{for(var n,u=this.__simulators__[Symbol.iterator]();!(e=(n=u.next()).done);e=!0){n.value.computeInputOutput(t)}}catch(t){r=!0,i=t}finally{try{e||null==u.return||u.return()}finally{if(r)throw i}}var o=!0,l=!1,_=void 0;try{for(var a,s=this.__simulators__[Symbol.iterator]();!(o=(a=s.next()).done);o=!0){a.value.sendMessages()}}catch(t){l=!0,_=t}finally{try{o||null==s.return||s.return()}finally{if(l)throw _}}}},{key:"wrapDeltafunc",value:function(t){this.sendDownMessages();var e=!0,r=!1,i=void 0;try{for(var n,u=this.__simulators__[Symbol.iterator]();!(e=(n=u.next()).done);e=!0){n.value.deltaFunc(t)}}catch(t){r=!0,i=t}finally{try{e||null==u.return||u.return()}finally{if(r)throw i}}this.__input__&&this.__input__.clear()}},{key:"nextTN",value:function(){var t=_utils.default.devs.time.Infinity,e=!0,r=!1,i=void 0;try{for(var n,u=this.__simulators__[Symbol.iterator]();!(e=(n=u.next()).done);e=!0){var o=n.value.nextTN();o<t&&(t=o)}}catch(t){r=!0,i=t}finally{try{e||null==u.return||u.return()}finally{if(r)throw i}}return t}},{key:"output",value:function(){return this.__output__}},{key:"hasInjectMessage",value:function(){return this.__input__&&!this.__input__.empty()}},{key:"injectMessage",value:function(t){this.__input__||(this.__input__=new _message.default),this.__input__.merge(t)}},{key:"putMessageEvent",value:function(t){t.event.timestamp(this.tn()),this.__output__.addContent(t)}},{key:"coupled",value:function(){return this.__coupled__}},{key:"informCoupling",value:function(){var t=!0,e=!1,r=void 0;try{for(var i,n=this.__coupled__.couprels().values()[Symbol.iterator]();!(t=(i=n.next()).done);t=!0){var u=i.value;u.src===this.__coupled__?this.addCouprel(u):u.src instanceof _atomic.default?u.src.simulator().addCouprel(u):u.src instanceof _coupled.default&&u.src.coordinator().addCouprel(u)}}catch(t){e=!0,r=t}finally{try{t||null==n.return||n.return()}finally{if(e)throw r}}}},{key:"setSimulators",value:function(){var t=!0,e=!1,r=void 0;try{for(var i,n=this.__coupled__.children().values()[Symbol.iterator]();!(t=(i=n.next()).done);t=!0){var u=i.value;u instanceof _atomic.default?this.addSimulator(u):u instanceof _coupled.default&&this.addCoordinator(u)}}catch(t){e=!0,r=t}finally{try{t||null==n.return||n.return()}finally{if(e)throw r}}}},{key:"addSimulator",value:function(t){var e=new _coupledSimulator.default(t);e.parent(this),t.simulator(e),this.__simulators__.add(e)}},{key:"addCoordinator",value:function(t){var e=new _coupledCoordinator.default(t);e.parent(this),t.coordinator(e),this.__simulators__.add(e)}},{key:"sendDownMessages",value:function(){if(this.__input__&&!this.__input__.empty()){var t=this.convertInput(this.__input__),e=!0,r=!1,i=void 0;try{for(var n,u=t[Symbol.iterator]();!(e=(n=u.next()).done);e=!0){var o=n.value;o.model instanceof _atomic.default?o.model.simulator().putMessageEvent(content):o.model instanceof _coupled.default&&o.model.coordinator().putMessageEvent(content)}}catch(t){r=!0,i=t}finally{try{e||null==u.return||u.return()}finally{if(r)throw i}}}}},{key:"convertInput",value:function(t){var e=new Array;if(t){var r=!0,i=!1,n=void 0;try{for(var u,o=t.contents()[Symbol.iterator]();!(r=(u=o.next()).done);r=!0){var l=u.value,_=!0,a=!1,s=void 0;try{for(var f,d=this.__couprels__[Symbol.iterator]();!(_=(f=d.next()).done);_=!0){var c=f.value;c.srcPort===l.port&&e.push({model:c.dest,content:{port:c.destPort,event:l.event}})}}catch(t){a=!0,s=t}finally{try{_||null==d.return||d.return()}finally{if(a)throw s}}}}catch(t){i=!0,n=t}finally{try{r||null==o.return||o.return()}finally{if(i)throw n}}}return e}},{key:"addCouprel",value:function(t){t?this.__couprels__.add(t):_logger.default.error("DevsCoordinator::addCouprel failed - rel is null")}},{key:"snapshot",value:function(t){if(!this.__coupled__)return _logger.default.error("DevsCoordinator::snapshot failed - model is null"),null;if(!t){var e=[],r=!0,i=!1,n=void 0;try{for(var u,o=this.__simulators__[Symbol.iterator]();!(r=(u=o.next()).done);r=!0){var l=u.value;e.push(l.snapshot())}}catch(t){i=!0,n=t}finally{try{r||null==o.return||o.return()}finally{if(i)throw n}}return{type:"coupled",coordinator:this.toJson(),model:this.__coupled__.snapshot(),simulators:e}}}},{key:"toJson",value:function(){var t={tl:this.__tl__,tn:this.__tn__};return this.__input__&&(t.input=this.__input__.toJson()),this.__output__&&(t.output=this.__output__.toJson()),t}},{key:"fromJson",value:function(t){}}]),e}(),_default=DevsCoordinator;exports.default=_default;