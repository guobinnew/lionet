"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _utils=_interopRequireDefault(require("./utils")),_logger=_interopRequireDefault(require("./logger")),_verison=_interopRequireDefault(require("./verison")),_message=_interopRequireDefault(require("./message")),_atomic=_interopRequireDefault(require("./atomic")),_coupled=_interopRequireDefault(require("./coupled")),_coupledSimulator=_interopRequireDefault(require("./coupled-simulator")),_coupledCoordinator=_interopRequireDefault(require("./coupled-coordinator"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),t}var DevsCoordinator=function(){function e(t){_classCallCheck(this,e),this.__coupled__=t,this.__coupled__.coordinator(this),this.__couprels__=new Set,this.__simulators__=new Set,this.__tl__=_utils.default.devs.time.Initial,this.__tn__=_utils.default.devs.time.Infinity,this.__input__=null,this.__output__=new _message.default,this.setSimulators(),this.informCoupling()}return _createClass(e,[{key:"tl",value:function(){return this.__tl__}},{key:"tn",value:function(){return this.__tn__}},{key:"initialize",value:function(t){var e=0<arguments.length&&void 0!==t?t:_utils.default.devs.time.Initial,r=!0,i=!1,n=void 0;try{for(var _,u=this.__simulators__[Symbol.iterator]();!(r=(_=u.next()).done);r=!0){_.value.initialize(e)}}catch(t){i=!0,n=t}finally{try{r||null==u.return||u.return()}finally{if(i)throw n}}this.__tl__=e,this.__tn__=this.nextTN()}},{key:"simulate",value:function(t){for(var e=0;e<t&&!(this.__tl__>=_utils.default.devs.time.Infinity);e++)this.computeInputOutput(this.__tn__),this.wrapDeltafunc(this.__tn__),this.__tl__=this.__tn__,this.__tn__=this.nextTN()}},{key:"simInject",value:function(t,e){t<=this.nextTN()&&(this.__input__=e,this.wrapDeltafunc(t),this.__tl__=t,this.__tn__=this.nextTN())}},{key:"computeInputOutput",value:function(t){this.__output__.clear();var e=!0,r=!1,i=void 0;try{for(var n,_=this.__simulators__[Symbol.iterator]();!(e=(n=_.next()).done);e=!0){n.value.computeInputOutput(t)}}catch(t){r=!0,i=t}finally{try{e||null==_.return||_.return()}finally{if(r)throw i}}var u=!0,o=!1,l=void 0;try{for(var a,s=this.__simulators__[Symbol.iterator]();!(u=(a=s.next()).done);u=!0){a.value.sendMessages()}}catch(t){o=!0,l=t}finally{try{u||null==s.return||s.return()}finally{if(o)throw l}}}},{key:"wrapDeltafunc",value:function(t){this.sendDownMessages();var e=!0,r=!1,i=void 0;try{for(var n,_=this.__simulators__[Symbol.iterator]();!(e=(n=_.next()).done);e=!0){n.value.deltaFunc(t)}}catch(t){r=!0,i=t}finally{try{e||null==_.return||_.return()}finally{if(r)throw i}}this.__input__&&this.__input__.clear()}},{key:"nextTN",value:function(){var t=_utils.default.devs.time.Infinity,e=!0,r=!1,i=void 0;try{for(var n,_=this.__simulators__[Symbol.iterator]();!(e=(n=_.next()).done);e=!0){var u=n.value.nextTN();u<t&&(t=u)}}catch(t){r=!0,i=t}finally{try{e||null==_.return||_.return()}finally{if(r)throw i}}return t}},{key:"output",value:function(){return this.__output__}},{key:"hasInjectMessage",value:function(){return this.__input__&&!this.__input__.empty()}},{key:"injectMessage",value:function(t){this.__input__||(this.__input__=new _message.default),this.__input__.merge(t)}},{key:"putMessageEvent",value:function(t){t.event.timestamp(this.tn()),this.__output__.addContent(t)}},{key:"coupled",value:function(){return this.__coupled__}},{key:"informCoupling",value:function(){var t=!0,e=!1,r=void 0;try{for(var i,n=this.__coupled__.couprels().values()[Symbol.iterator]();!(t=(i=n.next()).done);t=!0){var _=i.value;_.src===this.__coupled__?this.addCouprel(_):_.src instanceof _atomic.default?_.src.simulator().addCouprel(_):_.src instanceof _coupled.default&&_.src.coordinator().addCouprel(_)}}catch(t){e=!0,r=t}finally{try{t||null==n.return||n.return()}finally{if(e)throw r}}}},{key:"setSimulators",value:function(){var t=!0,e=!1,r=void 0;try{for(var i,n=this.__coupled__.children().values()[Symbol.iterator]();!(t=(i=n.next()).done);t=!0){var _=i.value;_ instanceof _atomic.default?this.addSimulator(_):_ instanceof _coupled.default&&this.addCoordinator(_)}}catch(t){e=!0,r=t}finally{try{t||null==n.return||n.return()}finally{if(e)throw r}}}},{key:"addSimulator",value:function(t){var e=new _coupledSimulator.default(t);e.parent(this),this.__simulators__.add(e)}},{key:"addCoordinator",value:function(t){var e=new _coupledCoordinator.default(t);e.parent(this),this.__simulators__.add(e)}},{key:"sendDownMessages",value:function(){if(this.__input__&&!this.__input__.empty()){var t=this.convertInput(this.__input__),e=!0,r=!1,i=void 0;try{for(var n,_=t[Symbol.iterator]();!(e=(n=_.next()).done);e=!0){var u=n.value;u.model instanceof _atomic.default?u.model.simulator().putMessageEvent(content):u.model instanceof _coupled.default&&u.model.coordinator().putMessageEvent(content)}}catch(t){r=!0,i=t}finally{try{e||null==_.return||_.return()}finally{if(r)throw i}}}}},{key:"convertInput",value:function(t){var e=new Array;if(t){var r=!0,i=!1,n=void 0;try{for(var _,u=t.contents()[Symbol.iterator]();!(r=(_=u.next()).done);r=!0){var o=_.value,l=!0,a=!1,s=void 0;try{for(var d,f=this.__couprels__[Symbol.iterator]();!(l=(d=f.next()).done);l=!0){var c=d.value;c.srcPort===o.port&&e.push({model:c.dest,content:{port:c.destPort,event:o.event}})}}catch(t){a=!0,s=t}finally{try{l||null==f.return||f.return()}finally{if(a)throw s}}}}catch(t){i=!0,n=t}finally{try{r||null==u.return||u.return()}finally{if(i)throw n}}}return e}},{key:"addCouprel",value:function(t){t?this.__couprels__.add(t):_logger.default.error("DevsCoordinator::addCouprel failed - rel is null")}},{key:"snapshot",value:function(t){return this.__coupled__?t?void this.__coupled__.snapshot(t.model):{type:"coordinator",version:_verison.default.current,model:this.__coupled__.snapshot()}:(_logger.default.error("DevsCoordinator::snapshot failed - model is null"),null)}},{key:"toJson",value:function(){var t={tl:this.__tl__,tn:this.__tn__};return this.__input__&&(t.input=this.__input__.toJson()),this.__output__&&(t.output=this.__output__.toJson()),t}},{key:"fromJson",value:function(t){if(!t)return _logger.default.error("DevsCoordinator::fromJson failed - json is null"),null;_utils.default.common.isNumber(t.tl)?this.__tl__=t.tl:(_logger.default.warn("DevsCoordinator::fromJson - tl is not a number"),this.__tl__=_utils.default.devs.time.Initial),_utils.default.common.isNumber(t.tn)?this.__tn__=t.tn:(_logger.default.warn("DevsCoordinator::fromJson - tn is not a number"),this.__tn__=_utils.default.devs.time.Infinity),t.input?(this.__input__=new _message.default,this.__input__.fromJson(t.input)):this.__input__=null,t.output&&this.__output__.fromJson(t.output)}}]),e}(),_default=DevsCoordinator;exports.default=_default;