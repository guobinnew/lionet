"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _model=_interopRequireDefault(require("./model")),_utils=_interopRequireDefault(require("./utils")),_logger=_interopRequireDefault(require("./logger"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _createForOfIteratorHelper(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var o=0,n=function(){};return{s:n,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var l,i=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return i=e.done,e},e:function(e){a=!0,l=e},f:function(){try{i||null==r.return||r.return()}finally{if(a)throw l}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,o=new Array(t);r<t;r++)o[r]=e[r];return o}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _get(e,t,r){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var o=_superPropBase(e,t);if(o){var n=Object.getOwnPropertyDescriptor(o,t);return n.get?n.get.call(r):n.value}})(e,t,r||e)}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(r){var o=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(r);return _possibleConstructorReturn(this,o?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var DevsCoupled=function(){_inherits(a,_model["default"]);var r=_createSuper(a);function a(e){var t;return _classCallCheck(this,a),(t=r.call(this,e)).__coordinator__=null,t.__children__=new Map,t.__couprels__=new Map,t}return _createClass(a,[{key:"prepare",value:function(e){if(e){if(_get(_getPrototypeOf(a.prototype),"prepare",this).call(this,e),this.__children__.clear(),_utils.default.common.isArray(e.children)){var t,r=_createForOfIteratorHelper(e.children);try{for(r.s();!(t=r.n()).done;){var o=t.value;this.add(o)}}catch(e){r.e(e)}finally{r.f()}}if(this.__couprels__.clear(),_utils.default.common.isArray(e.links)){var n,l=_createForOfIteratorHelper(e.links);try{for(l.s();!(n=l.n()).done;){var i=n.value;this.addCouprel(i)}}catch(e){l.e(e)}finally{l.f()}}}}},{key:"add",value:function(e){var t;e instanceof _model.default?(t=e.name(),this.__children__.has(t)&&_logger.default.warn("DevsCoupled::add - found duplicated name: ".concat(t)),this.__children__.set(t,e)):_logger.default.error("DevsCoupled::add failed - child is not a DevsModel")}},{key:"children",value:function(){return this.__children__}},{key:"couprels",value:function(){return this.__couprels__}},{key:"coordinator",value:function(e){if(!e)return this.__coordinator__;_utils.default.common.isObject(e)?this.__coordinator__=e:_logger.default.error("DevsCoupled::coordinator failed - invalid param ".concat(e))}},{key:"child",value:function(e){return _utils.default.common.isString(e)?e===this.name()?this:this.__children__.get(e):(_logger.default.error("DevsCoupled::child failed - name is not a string"),null)}},{key:"addCouprel",value:function(e){var t,r;e&&((t=Object.assign({},e)).src=this.child(t.src),t.src?(t.dest=this.child(e.dest),t.dest?(t.src===this&&this.addInport(e.srcPort),t.dest===this&&this.addOutport(e.destPort),r=this.couprelHandle(t),this.__couprels__.has(r)?_logger.default.warn("DevsCoupled::addCouprel failed - found duplicated couprel: ".concat(e)):this.__couprels__.set(r,t)):_logger.default.error("DevsCoupled::addCouprel failed - dest <".concat(e.dest,"> is invalid"))):_logger.default.error("DevsCoupled::addCouprel failed - src <".concat(e.src,"> is invalid")))}},{key:"couprelHandle",value:function(e){return e&&e.src&&e.dest?_utils.default.common.hashString(e.src.id()+":"+e.srcPort+">"+e.dest.id()+":"+e.destPort):(_logger.default.error("DevsCoupled::couprelHandle failed - couprel is invalid"),null)}},{key:"hasCouprel",value:function(e){if(!e)return _logger.default.error("DevsCoupled::hasCouprel failed - couprel is null"),!1;var t=this.couprelHandle(e);return this.__couprels__.has(t)}},{key:"initialize",value:function(){var e,t=_createForOfIteratorHelper(this.__children__.values());try{for(t.s();!(e=t.n()).done;){e.value.initialize()}}catch(e){t.e(e)}finally{t.f()}}},{key:"getLinks",value:function(){var e,t=new Array,r=_createForOfIteratorHelper(this.__couprels__.values());try{for(r.s();!(e=r.n()).done;){var o=e.value;t.push({src:o.src.name(),srcPort:o.srcPort,dest:o.dest.name(),destPort:o.destPort})}}catch(e){r.e(e)}finally{r.f()}return t}},{key:"dump",value:function(){var e,t=new Array,r=_createForOfIteratorHelper(this.__children__.values());try{for(r.s();!(e=r.n()).done;){var o=e.value;t.push(o.dump())}}catch(e){r.e(e)}finally{r.f()}return Object.assign(_get(_getPrototypeOf(a.prototype),"dump",this).call(this),{type:"coupled",class:this.__proto__.__classId__,children:t,links:this.getLinks()})}},{key:"toJson",value:function(){return Object.assign(_get(_getPrototypeOf(a.prototype),"toJson",this).call(this),{type:"coupled",class:this.__proto__.__classId__})}},{key:"fromJson",value:function(e){"coupled"===e.type?e.class===this.__proto__.__classId__?_get(_getPrototypeOf(a.prototype),"fromJson",this).call(this,e):_logger.default.error("DevsCoupled::fromJson failed - json.class is invalid, expectd to be ".concat(this.__proto__.__classId__)):_logger.default.error("DevsCoupled::fromJson failed - json.type is not coupled")}},{key:"snapshot",value:function(e){if(!e){var t=this.toJson();t.children=new Array;var r,o=_createForOfIteratorHelper(this.__children__.values());try{for(o.s();!(r=o.n()).done;){var n=r.value;t.children.push(n.snapshot())}}catch(e){o.e(e)}finally{o.f()}return t.links=this.getLinks(),this.__coordinator__&&(t.coordinator=this.__coordinator__.toJson()),t}if(this.fromJson(e),this.__coordinator__&&this.__coordinator__.fromJson(e.coordinator),_utils.default.common.isArray(e.children)){var l,i=_createForOfIteratorHelper(e.children);try{for(i.s();!(l=i.n()).done;){var a=l.value,s=this.__children__.get(a.name);s?s.snapshot(a):_logger.default.error("DevsCoupled::fromJson failed - model <".concat(a.name,"> is not existed"))}}catch(e){i.e(e)}finally{i.f()}}else _logger.default.warn("DevsCoupled::fromJson - json.children is not array")}}]),a}();DevsCoupled.prototype.__classId__="DevsCoupled";var _default=DevsCoupled;exports.default=DevsCoupled;